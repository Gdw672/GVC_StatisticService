<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Отчет по данным</title>
  <link rel="stylesheet" href="styles.css">
  <script src="plotly-3.0.1.min.js" charset="utf-8"></script>
</head>
<body>
   <div class="header">
    <div class="container">
      <div class="header-content">
        <h1>Отчет по данным</h1>
        <div class="log-container">
          <div class="log-box">
              
        </div>
         </div>

        <div class="authsect">
          <input id="login" class="form-input hidden" type="text" placeholder="GVC\ФамилияИО" required>
          <input id="password" class="form-input hidden" type="password" placeholder="Пароль" maxlength="30" minlength="14" required>
          <button id="savepasswordButton" class="btn btn-xs btn-secondary btn-password hidden">!</button>
          <button id="passwordButton" class="btn btn-xs btn-secondary btn-password">⛭</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="filters-section">
      <div id="dateFilters" class="date-filters">
        <div class="date-filter">
          <label for="startDate">Дата начала:</label>
          <input type="date" id="startDate" class="form-input" value="2025-07-01">
        </div>
        <select name="Диапазон" id="rangeData" class="form-input">
  <option value="">Промежуток</option>
  <option value="week">Неделя</option>
  <option value="doubleweek">Две недели</option>
  <option value="month">Месяц</option>
  <option value="quarter">Квартал</option>
  <option value="year">Год</option>
</select>
        <div class="date-filter">
          <label for="endDate">Дата окончания:</label>
          <input type="date" id="endDate" class="form-input" value="2025-07-31">
        </div>
        <button id="loadDataButton" class="btn btn-primary">Нет базы данных</button>
          <button id="downloadHideButton" class="btn btn-xs btn-secondary right">⇩</button>
      </div>
    </div>
    

      <div class="section hidden" id="downloadContainer">
        <div class="download-section">
          <p>Выберите диапазон дат для проверки данных:</p>
          <div class="date-filters">
            <div class="date-filter">
              <label for="downloadstartDate">Дата начала:</label>
              <input type="date" id="checkStartDate" class="form-input" value="2025-07-15">
            </div>
             <select name="Диапазон" id="checkrangeData" class="form-input">
  <option value="">Промежуток</option>
  <option value="week">Неделя</option>
  <option value="doubleweek">Две недели</option>
  <option value="month">Месяц</option>
  <option value="quarter">Квартал</option>
  <option value="year">Год</option>
</select>
            <div class="date-filter">
              <label for="downloadendDate">Дата окончания:</label>
              <input type="date" id="checkEndDate" class="form-input" value="2025-07-18">
            </div>
            <button id="checkDataButton" class="btn btn-primary">Проверить</button>
          </div>
        </div>
    </div>
    </div>
    
<div class="tablecontainer"> 
    <div class="section table-section">
      <div class="section-header">
        <div class="section-name-header">
          <h2 class="section-title">Таблица</h2>
  
          <button id="toggleButton" class="btn btn-secondary export">Изменить вид</button>
          <button id="csv-Button" class="btn btn-secondary export">Экспортировать в csv</button>
          <button id="xlsx-Button" class="btn btn-secondary export">Экспортировать в xlsx</button>
        </div>

        <button id="resetButton" class="btn btn-secondary btn-xs right">↻</button>
        <div class="section-slider">
          
          <div class="slider-container">
            <input type="range" min="0" max="100" value="50" class="sliderV" id="mySliderV">
          </div>
          <div class="slider-container">
            <input type="range" min="0" max="100" value="50" class="sliderH" id="mySliderH">
          </div>
        </div>
      </div>
      

      <div id="tableContainer" class="table-container"></div>
      <div class="resize-handle-right"></div>
      </div>
 </div>

    <div class="container">
    <div id="listsContainer" class="section lists-container"></div>
    <div class="section">
      <div id="chartsContainer" class="charts-grid"></div>
    </div>
  </div>


  <!-- Подключаем модули -->
  <script src="table-manager.js"></script>
  <script src="chart-manager.js"></script>
  
  <script>

let lastScrollTop = 0;
window.addEventListener('scroll', () => {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  if (scrollTop > 1) {
    document.body.classList.add('scrolled');
  } else {
    document.body.classList.remove('scrolled');
  }
  lastScrollTop = scrollTop;
});

function setupCellSelection() {
  document.addEventListener("click", (e) => {
    if (e.target.tagName === 'TD' && !e.target.classList.contains('date-column')) {
      e.target.classList.toggle("selectedcell");
    }
  });
}


function btncheck() {
  const checkDataButton = document.getElementById("checkDataButton");

  checkDataButton.addEventListener("click", () => {
    checkData();
  })}


async function checkData() {
  const startDate = document.getElementById('checkStartDate').value;
  const endDate = document.getElementById('checkEndDate').value;
  const checkApiUrl = "http://localhost:5134/api/Database/redownloadReportsByDate";


  if (!startDate || !endDate) {
    logMessage("Выберите диапазон дат");
    return;
  }

  // Формируем URL с параметрами
  const url = new URL(checkApiUrl);
  url.searchParams.append('startDate', startDate);
  url.searchParams.append('endDate', endDate);

  logMessage(`Проверка данных для периода ${startDate} - ${endDate}`);

  try {
    const response = await fetch(url.toString());
    
    if (!response.ok) {
      logMessage(`Ошибка HTTP: ${response.status}`);
      return;
    }

    const data = await response.json();

    if (!data || data.length === 0) {
      logMessage("Нет данных для выбранного диапазона дат");
      return;
    }

    logMessage(`Найдено ${data.length} записей данных`);
    logMessage("Проверка завершена успешно");
  } catch (error) {
    logMessage(`Ошибка проверки данных: ${error.message}`);
  }
}

function logMessage(msg) {
  const logBox = document.querySelector(".log-box");
  const placeholder = document.querySelector(".h5");

  if (placeholder) placeholder.remove();

  const time = new Date().toLocaleTimeString();
  const entry = document.createElement("p");
  entry.textContent = `[${time}] ${msg}`;

  logBox.prepend(entry);

  const atBottom = logBox.scrollHeight - logBox.scrollTop === logBox.clientHeight;
  if (atBottom) {
    logBox.scrollTop = logBox.scrollHeight;
  }
}


function setupAuthSection() {
  const passBtn = document.getElementById('passwordButton');
  const login = document.getElementById('login');
  const password = document.getElementById('password');
  const saveBtn = document.getElementById('savepasswordButton');

  passBtn.addEventListener('click', () => {
    login.classList.toggle('hidden');
    password.classList.toggle('hidden');
    saveBtn.classList.toggle('hidden');
  });
  
  saveBtn.addEventListener('click', () => {
    const loginVal = login.value;
    const passwordVal = password.value;

    const data = {
      login: loginVal,
      password: passwordVal,
      savedAt: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const dateStr = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `пароли/password_${dateStr}.json`;

    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);

    logMessage("Пароль и логин сохранены");
  });
}


document.addEventListener('DOMContentLoaded', function() {
    const tabBtn = document.querySelector('.tab-btn');
    const tabContent = document.querySelector('.tab-content');
    
    if (tabBtn && tabContent) {
        tabBtn.addEventListener('click', function() {
            // Переключаем класс active у кнопки
            tabBtn.classList.toggle('active');
            
            // Переключаем видимость контента
            if (tabContent.style.display === 'none') {
                tabContent.style.display = '';
            } else {
                tabContent.style.display = 'none';
            }
        });
    }

});

function initCurrentMonthDates() {
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  
  startDateInput.value = startOfMonth.toISOString().split('T')[0];
  endDateInput.value = endOfMonth.toISOString().split('T')[0];
}

function calculateEndDate(startInputId, rangeSelectId, endInputId) {
  const startDateInput = document.getElementById(startInputId);
  const endDateInput = document.getElementById(endInputId);
  const rangeSelect = document.getElementById(rangeSelectId);
  
  const startDate = new Date(startDateInput.value);
  const range = rangeSelect.value;
  let endDate;

  switch (range) {
    case 'week':
      endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6);
      break;
    case 'doubleweek':
      endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 13);
      break;
    case 'month':
      endDate = new Date(startDate);
      endDate.setMonth(startDate.getMonth() + 1);
      break;
    case 'quarter':
      endDate = new Date(startDate);
      endDate.setMonth(startDate.getMonth() + 3);
      break;
    case 'year':
      endDate = new Date(startDate);
      endDate.setFullYear(startDate.getFullYear() + 1);
      break;
    default:
      endDate = new Date(startDate);
  }

  endDateInput.value = endDate.toISOString().split('T')[0];
}

function setupDownloadSection() {
  const dHideBtn = document.getElementById('downloadHideButton');
  const dContainer = document.getElementById('downloadContainer');

  dHideBtn.addEventListener('click', () => {
    dContainer.classList.toggle('hidden');
  });
}



function setupDateCalculators() {
  const startDateInput = document.getElementById('startDate');
  const rangeSelect = document.getElementById('rangeData');
  const checkStartDateInput = document.getElementById('checkStartDate');
  const checkRangeSelect = document.getElementById('checkrangeData');

  function safeCalculate(startId, rangeId, endId) {
    const rangeValue = document.getElementById(rangeId).value;
    if (rangeValue) {
      calculateEndDate(startId, rangeId, endId);
    }
  }

  startDateInput.addEventListener('change', () => safeCalculate('startDate', 'rangeData', 'endDate'));
  rangeSelect.addEventListener('change', () => safeCalculate('startDate', 'rangeData', 'endDate'));
  
  checkStartDateInput.addEventListener('change', () => safeCalculate('checkStartDate', 'checkrangeData', 'checkEndDate'));
  checkRangeSelect.addEventListener('change', () => safeCalculate('checkStartDate', 'checkrangeData', 'checkEndDate'));

  // Не пересчитываем по умолчанию если пользователь ничего не выбрал
  safeCalculate('startDate', 'rangeData', 'endDate');
  safeCalculate('checkStartDate', 'checkrangeData', 'checkEndDate');
}


const sliderV = document.getElementById("mySliderV");
const sliderH = document.getElementById("mySliderH");

// Функция обновления стилей
function updateStyles() {
    // Получаем значения слайдеров
    const valueV = sliderV.value;
    const valueH = sliderH.value;

if (document.querySelector(".table-container table")) {
   // Применяем значения слайдеров к стилям (исключая первую ячейку)
  if (document.querySelector(".table-container table")) {
    // Применяем значения слайдеров к стилям (исключая первую ячейку)
    document.querySelectorAll(".table-container th:not(:first-child)").forEach(th => {
        th.style.fontSize = Math.max(5, valueV / 5) + "px";
        th.style.padding = Math.max(1, valueV / 10) + "px";
        
        // Плавные переходы для всех свойств
        th.style.transition = "all 0.2s ease";
        
        // Перенос текста для маленьких значений
        if (valueV < 50) {
            th.style.whiteSpace = "normal"; // разрешает перенос
            th.style.wordWrap = "break-word"; // переносит длинные слова
            th.style.wordBreak = "break-word"; // дополнительная поддержка
        } else {
            th.style.whiteSpace = "nowrap"; // запрещает перенос
        }
        
        // Плавное изменение по вашей логике
        if (valueV < 30) {
            th.style.fontWeight = 100 + (valueV / 30) * 500;
            th.style.letterSpacing = (0.2 * (30 - valueV) / 30) + "px";
            th.style.lineHeight = 3 - ((valueV / 30) * 1.9);
        } else if (valueV > 70) {
            th.style.fontWeight = 600 + ((valueV - 70) / 30) * 100;
            th.style.lineHeight = 1.1 - ((valueV - 70) / 30) * 1;
            th.style.letterSpacing = "0px";
        } else {
            th.style.fontWeight = "700";
            th.style.lineHeight = "1.1";
            th.style.letterSpacing = "0px";
        }
    });
}

    document.querySelector(".table-container table").style.lineHeight = (valueH / 100) + 0.001;  // Например, от 0 до 1
}
}

// Добавляем события для слайдеров
sliderV.addEventListener("input", updateStyles);
sliderH.addEventListener("input", updateStyles);


function setupExportButtons() {
  const downloadCSVButton = document.getElementById("csv-Button");
  const downloadXLSXButton = document.getElementById("xlsx-Button");

  downloadCSVButton.addEventListener("click", () => {
    try {
      const container = document.getElementById(TableManager.config.tableContainer);
      const table = container.querySelector("table");
      if (!table) throw new Error("Таблица не найдена");

      const isTransposed = window.AppState.transposed;
      const rawData = TableManager.getRawData();
      const formattedData = rawData.map(entry => ({ ...entry }));
      const dates = formattedData.map(d => new Date(d.дата_отчета)).sort((a, b) => a - b);

      const startDate = dates[0] ? new Date(dates[0]).toLocaleDateString('ru-RU').split('.').reverse().join('-') : "unknown";
      const endDate = dates[dates.length - 1] ? new Date(dates[dates.length - 1]).toLocaleDateString('ru-RU').split('.').reverse().join('-') : "unknown";

      const fields = Object.keys(formattedData[0] || {}).filter(f => f !== "id");

      let csv = [];

      if (!isTransposed) {
        const header = ["Дата", ...fields.filter(f => f !== "дата_отчета")];
        csv.push(header.join(";"));

        formattedData.forEach(entry => {
          const row = [
            new Date(entry.дата_отчета).toLocaleDateString('ru-RU').split('.').reverse().join('-'),
            ...header.slice(1).map(key => entry[key])
          ];
          csv.push(row.join(";"));
        });

      } else {
        const header = ["Показатель", ...formattedData.map(d => new Date(d.дата_отчета).toLocaleDateString('ru-RU').split('.').reverse().join('-'))];
        csv.push(header.join(";"));

        fields.filter(f => f !== "дата_отчета").forEach(field => {
          const row = [field, ...formattedData.map(d => d[field])];
          csv.push(row.join(";"));
        });
      }

      const BOM = "\uFEFF";
      const blob = new Blob([BOM + csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
      const filename = `${startDate}///${endDate}.csv`;

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);

      logMessage("CSV успешно скачан: " + filename);
    } catch (e) {
      logMessage("Ошибка при скачивании CSV: " + e.message);
    }
  });

  downloadXLSXButton.addEventListener("click", () => {
    try {
      const container = document.getElementById(TableManager.config.tableContainer);
      const table = container.querySelector("table");
      if (!table) throw new Error("Таблица не найдена");

      const isTransposed = window.AppState.transposed;
      const rawData = TableManager.getRawData();
      const formattedData = rawData.map(entry => ({ ...entry }));
      const dates = formattedData.map(d => new Date(d.дата_отчета)).sort((a, b) => a - b);

      const startDate = dates[0] ? new Date(dates[0]).toLocaleDateString('ru-RU').split('.').reverse().join('-') : "unknown";
      const endDate = dates[dates.length - 1] ? new Date(dates[dates.length - 1]).toLocaleDateString('ru-RU').split('.').reverse().join('-') : "unknown";

      const fields = Object.keys(formattedData[0] || {}).filter(f => f !== "id");

      let xlsxData = [];

      if (!isTransposed) {
        const header = ["Дата", ...fields.filter(f => f !== "дата_отчета")];
        xlsxData.push(header);

        formattedData.forEach(entry => {
          const row = [
            new Date(entry.дата_отчета).toLocaleDateString('ru-RU').split('.').reverse().join('-'),
            ...header.slice(1).map(key => entry[key])
          ];
          xlsxData.push(row);
        });

      } else {
        const header = ["Показатель", ...formattedData.map(d => new Date(d.дата_отчета).toLocaleDateString('ru-RU').split('.').reverse().join('-'))];
        xlsxData.push(header);

        fields.filter(f => f !== "дата_отчета").forEach(field => {
          const row = [field, ...formattedData.map(d => d[field])];
          xlsxData.push(row);
        });
      }

      let xml = '<?xml version="1.0" encoding="UTF-8"?>';
      xml += '<ss:Workbook xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
      xml += '<ss:Worksheet ss:Name="Sheet1"><ss:Table>';

      xlsxData.forEach((row, rowIndex) => {
        xml += '<ss:Row>';
        row.forEach(cell => {
          xml += `<ss:Cell><ss:Data ss:Type="String">${cell}</ss:Data></ss:Cell>`;
        });
        xml += '</ss:Row>';
      });

      xml += '</ss:Table></ss:Worksheet>';
      xml += '</ss:Workbook>';

      const BOM = "\uFEFF";
      const blob = new Blob([BOM + xml], { type: 'application/vnd.ms-excel' });
      const filename = `${startDate}///${endDate}.xls`;

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);

      logMessage("XLSX успешно скачан: " + filename);
    } catch (e) {
      logMessage("Ошибка при скачивании XLSX: " + e.message);
    }
  });

}

// Инициализация начальных значений
updateStyles();

    // Инициализация приложения
    const APP_CONFIG = {
        apiUrl: "http://localhost:5134/api/Database/getReportsByRange",
      tableContainer: "tableContainer",
      listsContainer: "listsContainer",
      chartsContainer: "chartsContainer",
      toggleButton: "toggleButton",
      startDateInput: "startDate",
      endDateInput: "endDate",
      loadDataButton: "loadDataButton",
        checkApiUrl: "http://localhost:5134/api/Database/redownloadReportsByDate",
      checkDataButton: "checkDataButton",
    };

    // Глобальное состояние приложения
    window.AppState = {
      originalData: [],
      selectedParamsByList: [[]],
      selectedDates: new Set(),
      selectedCells: new Set(),
      activeListIndex: 0,
      transposed: true, // Стартуем в перевернутом виде
      chartsVisible: [], // массив булевых значений для видимости графиков
  
    };
    
    // Инициализируем менеджеры
    document.addEventListener('DOMContentLoaded', async () => {
    const tabBtn = document.querySelector('.tab-btn');
    const tabContent = document.querySelector('.tab-content');
    
    if (tabBtn && tabContent) {
        tabBtn.addEventListener('click', function() {
            // Переключаем класс active у кнопки
            tabBtn.classList.toggle('active');
            
            // Переключаем видимость контента
            if (tabContent.style.display === 'none') {
                tabContent.style.display = '';
            } else {
                tabContent.style.display = 'none';
            }
        });
    }

    

      // Делаем менеджеры доступными глобально
      window.TableManager = TableManager;
      window.ChartManager = ChartManager;


     setupExportButtons();  
    initCurrentMonthDates();
    setupDateCalculators();
     setupCellSelection();
     setupAuthSection();
      
      TableManager.init(APP_CONFIG);
      ChartManager.init(APP_CONFIG);
      
      // Загружаем данные
      await TableManager.loadData();

      setupDownloadSection();
      btncheck();
    });
  </script>
</body>
</html>
    
  