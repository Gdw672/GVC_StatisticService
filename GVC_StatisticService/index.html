<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Отчет по данным</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
    }

    th {
      background-color: #eee;
      cursor: pointer;
    }

    .metric:hover {
      background-color: #cceeff;
    }

    .metric:active {
      background-color: #aaddff;
    }

    .selected {
      background-color: #d7f0ff !important;
      outline: 2px solid #007acc;
    }

    #toggleButton {
      margin-top: 10px;
      float: right;
    }

    #listsContainer {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .listBlock {
      border: 1px solid #aaa;
      padding: 10px;
      min-height: 40px;
      background: #f9f9f9;
      cursor: pointer;
    }

    .listBlock.active {
      background: #e0f7ff;
      border: 2px solid #007acc;
    }

    #addListButton {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
    }

    th.selected, td.selected {
  background-color: #007acc !important;
  color: white;
  font-weight: bold;
  border: 2px solid #005f99;
}

.tag {
  background-color: #007acc;
  color: white;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 13px;
}

  </style>
</head>
<body>
  <h3>Отчет по данным</h3>
  <button id="toggleButton">Повернуть таблицу</button>
  <div id="tableContainer"></div>

  <h4>График по тегам</h4>
  <div id="listsContainer"></div>
  <button id="addListButton">+ Добавить новый график</button>

  <script>
    const apiUrl = "http://localhost:5134/api/Database/testData";
let originalData = [];
let transposed = false;

let selectedParamsByList = [];
let selectedDates = [];
let activeListIndex = 0;

function initFirstList() {
  selectedParamsByList = [[]];
  renderLists();
}

function formatEntry(entry) {
  const result = { ...entry };
  if (result.дата_отчета) {
    result.дата_отчета_raw = new Date(result.дата_отчета);
    result.дата_отчета = new Date(result.дата_отчета).toLocaleDateString("ru-RU");
  }
  for (let key in result) {
    if (key.startsWith("процент_")) {
      result[key] = (result[key] * 100).toFixed(0) + " %";
    }
  }
  return result;
}

async function loadData() {
  try {
    const response = await fetch(apiUrl);
    const data = await response.json();
    originalData = data;
    renderTable(data);
    initFirstList();
  } catch (error) {
    console.error("Ошибка загрузки данных:", error);
  }
}

function toggleParam(param) {
  const list = selectedParamsByList[activeListIndex];
  const index = list.indexOf(param);
  if (index >= 0) {
    list.splice(index, 1);
  } else {
    list.push(param);
  }
  renderLists();
  renderTable(originalData);
}

function toggleDate(rawDate) {
  const timestamp = new Date(rawDate).getTime();
  const index = selectedDates.findIndex(d => new Date(d).getTime() === timestamp);
  if (index >= 0) {
    selectedDates.splice(index, 1);
  } else {
    selectedDates.push(rawDate);
  }
  selectedDates.sort((a, b) => new Date(a) - new Date(b));
  renderTable(originalData);
}

function renderLists() {
  const container = document.getElementById("listsContainer");
  container.innerHTML = "";
  selectedParamsByList.forEach((params, index) => {
    const block = document.createElement("div");
    block.className = "listBlock";
    if (index === activeListIndex) block.classList.add("active");

    block.innerHTML = "<strong>График " + (index + 1) + ":</strong> ";
    params.forEach(p => {
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.innerText = p;
      block.appendChild(tag);
    });

    block.addEventListener("click", () => {
      activeListIndex = index;
      renderLists();
      renderTable(originalData);
    });
    container.appendChild(block);
  });
}

function renderTable(data) {
  const container = document.getElementById("tableContainer");
  container.innerHTML = "";

  const formattedData = data.map(formatEntry);
  const fields = Object.keys(formattedData[0]).filter(f => f !== "id" && f !== "дата_отчета_raw");

  const table = document.createElement("table");

  if (!transposed) {
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    headerRow.appendChild(document.createElement("th")).innerText = "Дата";

    fields.filter(f => f !== "дата_отчета").forEach(field => {
      const th = document.createElement("th");
      th.innerText = field;
      if (selectedParamsByList[activeListIndex].includes(field)) th.classList.add("selected");
      th.addEventListener("click", () => toggleParam(field));
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    const sortedData = [...formattedData];
    const priority = selectedDates.map(d => new Date(d).toLocaleDateString("ru-RU"));
    sortedData.sort((a, b) => {
      const ia = priority.indexOf(a.дата_отчета);
      const ib = priority.indexOf(b.дата_отчета);
      if (ia >= 0 && ib >= 0) return ia - ib;
      if (ia >= 0) return -1;
      if (ib >= 0) return 1;
      return new Date(b.дата_отчета_raw) - new Date(a.дата_отчета_raw);
    });

    sortedData.forEach(entry => {
      const row = document.createElement("tr");

      const dateCell = document.createElement("td");
      dateCell.innerText = entry.дата_отчета;
      const isSelected = selectedDates.some(
        d => new Date(d).getTime() === entry.дата_отчета_raw.getTime()
      );
      if (isSelected) {
        dateCell.classList.add("selected");
      } else {
        dateCell.classList.remove("selected");
      }
      dateCell.addEventListener("click", () => toggleDate(entry.дата_отчета_raw));
      row.appendChild(dateCell);

      fields.filter(f => f !== "дата_отчета").forEach(field => {
        const cell = document.createElement("td");
        cell.innerText = entry[field];
        row.appendChild(cell);
      });

      tbody.appendChild(row);
    });

    table.appendChild(tbody);
  } else {
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    headerRow.appendChild(document.createElement("th")).innerText = "Показатель";

    const sortedDates = [...formattedData];
    const priority = selectedDates.map(d => new Date(d).toLocaleDateString("ru-RU"));
    sortedDates.sort((a, b) => {
      const ia = priority.indexOf(a.дата_отчета);
      const ib = priority.indexOf(b.дата_отчета);
      if (ia >= 0 && ib >= 0) return ia - ib;
      if (ia >= 0) return -1;
      if (ib >= 0) return 1;
      return new Date(b.дата_отчета_raw) - new Date(a.дата_отчета_raw);
    });

    sortedDates.forEach(entry => {
      const th = document.createElement("th");
      th.innerText = entry.дата_отчета;
      const isSelected = selectedDates.some(
        d => new Date(d).getTime() === entry.дата_отчета_raw.getTime()
      );
      if (isSelected) th.classList.add("selected");
      th.addEventListener("click", () => toggleDate(entry.дата_отчета_raw));
      headerRow.appendChild(th);
    });

    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    fields.filter(f => f !== "дата_отчета").forEach(field => {
      const row = document.createElement("tr");
      const paramCell = document.createElement("td");
      paramCell.innerText = field;
      if (selectedParamsByList[activeListIndex].includes(field)) paramCell.classList.add("selected");
      paramCell.addEventListener("click", () => toggleParam(field));
      row.appendChild(paramCell);

      sortedDates.forEach(entry => {
        const cell = document.createElement("td");
        cell.innerText = entry[field];
        row.appendChild(cell);
      });

      tbody.appendChild(row);
    });

    table.appendChild(tbody);
  }

  container.appendChild(table);
}

document.getElementById("toggleButton").addEventListener("click", () => {
  transposed = !transposed;
  renderTable(originalData);
});

document.getElementById("addListButton").addEventListener("click", () => {
  selectedParamsByList.push([]);
  activeListIndex = selectedParamsByList.length - 1;
  renderLists();
  renderTable(originalData);
});

loadData();
  </script>
</body>
</html>
